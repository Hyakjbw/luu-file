<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KHO MEME - H.HUY</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff0055;
            --secondary: #0000ff;
            --accent: #00ffcc;
            --bg-dark: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            color: white;
            padding-bottom: 80px;
        }

        /* --- NAV --- */
        .nav-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 999;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(20px);
            padding: 5px;
            border-radius: 100px;
            border: 1px solid var(--border);
            display: flex; gap: 5px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .nav-btn {
            background: transparent; border: none; color: #888;
            padding: 10px 25px; border-radius: 100px;
            font-weight: 700; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }

        .nav-btn.active {
            background: white; color: black;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        /* --- LAYOUT --- */
        .container { max-width: 800px; margin: 100px auto 0; padding: 20px; }
        
        .view-section { display: none; animation: fadeUp 0.5s ease; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARD STYLE --- */
        .card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 20px;
            text-align: center;
            overflow: hidden;
            position: relative;
        }

        .badge {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 255, 204, 0.1);
            color: var(--accent);
            border: 1px solid rgba(0, 255, 204, 0.3);
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .img-frame {
            min-height: 300px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            margin: 40px 0 20px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .img-frame img {
            max-width: 100%; height: auto;
            opacity: 0; transition: 0.5s; transform: scale(0.95);
        }
        .img-frame img.show { opacity: 1; transform: scale(1); }

        /* --- BUTTONS --- */
        .actions { display: flex; gap: 10px; justify-content: center; }
        
        .btn {
            border: none; padding: 15px 30px; border-radius: 15px;
            font-weight: 700; cursor: pointer; flex: 1;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; font-size: 15px;
        }

        .btn-reload { background: #333; color: white; }
        .btn-reload:hover { background: #444; }

        .btn-dl { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            box-shadow: 0 5px 20px rgba(255, 0, 85, 0.3);
        }
        .btn-dl:active { transform: scale(0.95); }

        /* --- GALLERY --- */
        .grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
        }
        @media (min-width: 600px) { .grid { grid-template-columns: repeat(4, 1fr); } }

        .grid-item {
            aspect-ratio: 1;
            background: #111;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        
        .overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s;
        }
        .grid-item:hover .overlay { opacity: 1; }

        /* --- LOADER --- */
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s infinite linear;
            position: absolute;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .info-txt { font-size: 12px; color: #666; margin-top: 15px; }
        
        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #fff; color: black; padding: 12px 25px;
            border-radius: 50px; font-weight: 700; opacity: 0; transition: 0.3s;
            display: flex; align-items: center; gap: 10px; z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    </style>
</head>
<body>

    <div class="nav-container">
        <button class="nav-btn active" onclick="switchTab('single')"><i class="fa-solid fa-bolt"></i> Random</button>
        <button class="nav-btn" onclick="switchTab('list')"><i class="fa-solid fa-grid-2"></i> Gallery</button>
    </div>

    <div class="container">
        <!-- SINGLE TAB -->
        <div id="single-tab" class="view-section active">
            <div class="card">
                <span class="badge" id="conn-status">GOOGLE LINKED</span>
                
                <h2 style="font-size: 1.5rem;">Meme Hub V5</h2>
                <div class="img-frame">
                    <div class="spinner" id="single-spinner"></div>
                    <img id="single-img" alt="Meme">
                </div>

                <div class="actions">
                    <button class="btn btn-reload" onclick="loadSingleMeme()">
                        <i class="fa-solid fa-rotate"></i> Đổi Ảnh
                    </button>
                    <button class="btn btn-dl" onclick="downloadCurrent()">
                        <i class="fa-solid fa-download"></i> Tải Về
                    </button>
                </div>
                <p class="info-txt"><i class="fa-brands fa-google-drive"></i> Ảnh được xử lý qua Google Server để đảm bảo tải thành công.</p>
            </div>
        </div>

        <!-- LIST TAB -->
        <div id="list-tab" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Kho Ảnh (Max 20)</h3>
                <button onclick="reloadGallery()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-weight:bold;">
                    <i class="fa-solid fa-trash"></i> Làm mới
                </button>
            </div>
            <div class="grid" id="gallery-grid"></div>
        </div>
    </div>

    <div id="toast" class="toast"><i class="fa-solid fa-check-circle" style="color:green"></i> <span>Đã lưu!</span></div>

    <script>
        /* ===== CẤU HÌNH SERVER =====
           Bước 1: Tạo Google Apps Script theo hướng dẫn.
           Bước 2: Dán URL script của bạn vào biến bên dưới.
           Nếu chưa có, mình dùng tạm server public (CodeTabs) để bạn test trước.
        */
        
        // Thay link này bằng link Google Script của bạn để ổn định nhất
        // Ví dụ: const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/XXXXX/exec";
        let GOOGLE_SCRIPT_URL = ""; 

        // Server dự phòng (Public Proxy) nếu bạn chưa setup Google Script
        const PUBLIC_PROXY = "https://api.codetabs.com/v1/proxy?quest=";

        const MEME_API = "https://api.phimtat.vn/api/random-meme/";
        
        // Biến lưu dữ liệu ảnh hiện tại (Base64)
        let currentBase64 = null;
        let isFetching = false;

        // --- HÀM 1: GỌI QUA "SERVER TRUNG GIAN" (QUAN TRỌNG NHẤT) ---
        async function fetchImageViaProxy(targetUrl) {
            try {
                // Ưu tiên dùng Google Script nếu có, nếu không dùng Public Proxy
                let finalUrl;
                if (GOOGLE_SCRIPT_URL) {
                    finalUrl = `${GOOGLE_SCRIPT_URL}?url=${encodeURIComponent(targetUrl)}`;
                } else {
                    finalUrl = `${PUBLIC_PROXY}${encodeURIComponent(targetUrl)}`;
                }

                const response = await fetch(finalUrl);
                
                // Nếu dùng Google Script của tôi cung cấp, nó trả về JSON
                if (GOOGLE_SCRIPT_URL) {
                    const json = await response.json();
                    if (json.status === 'success') return json.data; // Trả về chuỗi Base64
                } 
                
                // Nếu dùng Public Proxy, nó trả về Blob trực tiếp
                const blob = await response.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });

            } catch (e) {
                console.error("Proxy Error:", e);
                return null;
            }
        }

        // --- SINGLE VIEW LOGIC ---
        async function loadSingleMeme() {
            if (isFetching) return;
            isFetching = true;

            const img = document.getElementById('single-img');
            const spinner = document.getElementById('single-spinner');
            
            img.classList.remove('show');
            spinner.style.display = 'block';
            currentBase64 = null;

            // Tạo link random
            const randomUrl = MEME_API + "?id=" + Math.random();

            // Gọi qua Server trung gian
            const base64Data = await fetchImageViaProxy(randomUrl);

            spinner.style.display = 'none';
            
            if (base64Data) {
                currentBase64 = base64Data; // Lưu vào biến để tải
                img.src = base64Data;
                img.onload = () => {
                    img.classList.add('show');
                    isFetching = false;
                };
            } else {
                // Fallback nếu server lỗi
                img.src = "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDNqMGFxODZ4bmJxeXljdmN4YnZ4bmJxeXljdmN4YnZ4bmJxeXljdiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/VbnUQpnihPSIgIXuZv/giphy.gif";
                img.classList.add('show');
                isFetching = false;
                showToast("Server bận, thử lại sau!");
            }
        }

        function downloadCurrent() {
            if (!currentBase64) {
                showToast("Đang tải ảnh..."); 
                return;
            }
            saveBase64AsFile(currentBase64);
        }

        // --- GALLERY LOGIC ---
        async function reloadGallery() {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';
            
            // Giới hạn 20 ảnh như yêu cầu
            for (let i = 0; i < 20; i++) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.innerHTML = `<div class="spinner" style="position:relative; margin:auto; top:40%;"></div>`;
                grid.appendChild(item);
                
                // Load song song
                processGalleryItem(item);
            }
        }

        async function processGalleryItem(container) {
            const randomUrl = MEME_API + "?id=" + Math.random().toString(36);
            const base64 = await fetchImageViaProxy(randomUrl);

            if (base64) {
                container.innerHTML = `
                    <img src="${base64}" loading="lazy">
                    <div class="overlay">
                        <i class="fa-solid fa-download" style="font-size:24px; color:var(--accent)"></i>
                        <span style="font-size:12px; font-weight:bold; margin-top:5px">LƯU</span>
                    </div>
                `;
                // Click là tải luôn file Base64 đó
                container.onclick = () => saveBase64AsFile(base64);
            } else {
                container.remove(); // Xóa nếu lỗi
            }
        }

        // --- HÀM TẢI FILE TỪ BASE64 (CORE) ---
        async function saveBase64AsFile(base64) {
            const fetchRes = await fetch(base64);
            const blob = await fetchRes.blob();
            const file = new File([blob], `meme-${Date.now()}.jpg`, { type: "image/jpeg" });

            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Meme Hub',
                        text: 'Tải từ Google Server'
                    });
                } catch (e) {}
            } else {
                const a = document.createElement('a');
                a.href = base64;
                a.download = `meme-${Date.now()}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast("Đã tải xuống máy!");
            }
        }

        // --- UI ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            if(tab === 'single') {
                document.getElementById('single-tab').classList.add('active');
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else {
                document.getElementById('list-tab').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                if(document.getElementById('gallery-grid').children.length === 0) reloadGallery();
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.querySelector('span').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Init
        loadSingleMeme();

    </script>
</body>
</html>
