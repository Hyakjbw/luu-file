<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kho L∆∞u Tr·ªØ Drive</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; color: #333; }
        
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        input[type="file"] { width: 100%; margin-bottom: 15px; border: 1px dashed #ccc; padding: 20px; text-align: center; border-radius: 5px; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; margin-bottom: 5px; transition: 0.2s; }
        .btn-upload { background: #4285F4; }
        .btn-upload:hover { background: #3367d6; }
        .btn-refresh { background: #0F9D58; }
        .btn-refresh:hover { background: #0b8043; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #status { text-align: center; margin-bottom: 10px; font-size: 14px; }
        
        /* Danh s√°ch file */
        .file-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .file-info { overflow: hidden; }
        .file-name { font-weight: bold; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; display: block; }
        .file-meta { font-size: 12px; color: #777; margin-top: 3px; }
        
        .btn-down { background: #eee; color: #333; padding: 5px 15px; border-radius: 20px; text-decoration: none; font-size: 13px; font-weight: bold; }
        .btn-down:hover { background: #ddd; color: black; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4285F4; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h2>üìÅ H·ªá Th·ªëng Upload Drive</h2>

    <div class="card">
        <input type="file" id="fileInput">
        <div id="status"></div>
        <button class="btn-upload" id="uploadBtn" onclick="handleUpload()">‚¨ÜÔ∏è T·∫£i L√™n Ngay</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <strong>Danh s√°ch file</strong>
            <button onclick="loadFiles()" class="btn-refresh" style="width:auto; padding:5px 10px; font-size:12px; margin:0">üîÑ L√†m m·ªõi</button>
        </div>
        <div id="fileList">ƒêang t·∫£i danh s√°ch...</div>
    </div>

    <script>
        // === C·∫§U H√åNH ===
        // D√°n link Web App b·∫°n copy ·ªü B∆∞·ªõc 1 v√†o ƒë√¢y
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCJ3XXDvu6gnt2SJ5Ji9H5cbtUVSHA0JwmvjPn-BZU6vXCUD7_9kj1RhWGY7Ghi8qVaQ/exec";
        // ================

        // 1. H√†m Upload
        function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            
            if(fileInput.files.length === 0) {
                alert("Ch·ªçn file ƒëi b·∫°n ∆°i!");
                return;
            }
            
            const file = fileInput.files[0];
            if(file.size > 50 * 1024 * 1024) { // Gi·ªõi h·∫°n 50MB
                alert("File qu√° n·∫∑ng! Google Script ch·ªâ nh·∫≠n file < 50MB.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> ƒêang x·ª≠ l√Ω...';
            status.innerHTML = "ƒêang ƒë·∫©y file l√™n...";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                const base64 = reader.result.split(',')[1];
                
                fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        base64: base64,
                        mimeType: file.type,
                        filename: file.name
                    })
                })
                .then(r => r.json())
                .then(res => {
                    if(res.status === "success") {
                        status.innerHTML = '<span style="color:green">‚úÖ Th√†nh c√¥ng!</span>';
                        fileInput.value = ""; // Reset file
                        loadFiles(); // T·∫£i l·∫°i danh s√°ch ngay
                    } else {
                        status.innerHTML = '<span style="color:red">L·ªói: ' + res.message + '</span>';
                    }
                })
                .catch(err => {
                    status.innerHTML = '<span style="color:red">L·ªói m·∫°ng!</span>';
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '‚¨ÜÔ∏è T·∫£i L√™n Ngay';
                });
            };
        }

        // 2. H√†m L·∫•y danh s√°ch
        function loadFiles() {
            const listDiv = document.getElementById('fileList');
            listDiv.innerHTML = '<div class="loader"></div> ƒêang t·∫£i...';
            
            fetch(SCRIPT_URL + "?action=list")
            .then(r => r.json())
            .then(files => {
                if(!files || files.length === 0) {
                    listDiv.innerHTML = "Ch∆∞a c√≥ file n√†o.";
                    return;
                }
                
                let html = "";
                files.forEach(f => {
                    // Chuy·ªÉn ng√†y gi·ªù
                    let date = new Date(f.date).toLocaleDateString('vi-VN');
                    
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <span class="file-name" title="${f.name}">${f.name}</span>
                                <div class="file-meta">${f.size} ‚Ä¢ ${date}</div>
                            </div>
                            <a href="${f.link}" class="btn-down">‚¨á T·∫£i</a>
                        </div>
                    `;
                });
                listDiv.innerHTML = html;
            })
            .catch(err => {
                listDiv.innerHTML = "L·ªói t·∫£i danh s√°ch.";
            });
        }

        // T·ª± ch·∫°y khi v√†o trang
        loadFiles();
    </script>
</body>
</html>
