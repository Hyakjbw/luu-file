<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Multi-Upload</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Input Area */
        .upload-box { border: 2px dashed #4285F4; padding: 20px; text-align: center; border-radius: 8px; background: #f8fbff; }
        input[type="file"] { width: 100%; margin-bottom: 10px; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; margin-top: 10px; transition: 0.2s; }
        .btn-upload { background: #4285F4; }
        .btn-upload:hover { background: #3367d6; }
        .btn-refresh { background: #0F9D58; width: auto; padding: 8px 15px; font-size: 14px; float: right; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Progress Log */
        #logArea { margin-top: 15px; max-height: 150px; overflow-y: auto; font-size: 13px; border-top: 1px solid #eee; padding-top: 10px; display: none; }
        .log-item { margin-bottom: 5px; padding: 5px; border-radius: 4px; }
        .log-success { color: green; background: #e6fffa; }
        .log-error { color: red; background: #ffe6e6; }
        .log-waiting { color: #666; }

        /* File List */
        .file-list { margin-top: 15px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .file-name { font-weight: 500; font-size: 14px; max-width: 70%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-down { background: #eee; color: #333; padding: 5px 12px; border-radius: 15px; text-decoration: none; font-size: 12px; font-weight: bold; }
        .btn-down:hover { background: #ddd; color: black; }
    </style>
</head>
<body>

    <h2>üìÅ Upload-Drive</h2>

    <div class="card">
        <div class="upload-box">
            <input type="file" id="fileInput" multiple>
            <button class="btn-upload" id="uploadBtn" onclick="handleBatchUpload()">‚¨ÜÔ∏è T·∫£i T·∫•t C·∫£ L√™n</button>
        </div>
        <div id="logArea"></div>
    </div>

    <div class="card">
        <div style="overflow: hidden; margin-bottom: 10px;">
            <strong style="float:left; line-height: 35px;">Danh s√°ch file</strong>
            <button onclick="loadFiles()" class="btn-refresh">üîÑ L√†m m·ªõi</button>
        </div>
        <div id="fileList" class="file-list">ƒêang t·∫£i danh s√°ch...</div>
    </div>

    <script>
        // === C·∫§U H√åNH (D√ÅN LINK WEB APP C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ===
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCJ3XXDvu6gnt2SJ5Ji9H5cbtUVSHA0JwmvjPn-BZU6vXCUD7_9kj1RhWGY7Ghi8qVaQ/exec";
        // ====================================================

        // H√†m x·ª≠ l√Ω upload nhi·ªÅu file
        async function handleBatchUpload() {
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            const logArea = document.getElementById('logArea');
            
            const files = fileInput.files;
            if(files.length === 0) {
                alert("B·∫°n ch∆∞a ch·ªçn file n√†o!");
                return;
            }

            // Reset giao di·ªán
            btn.disabled = true;
            logArea.style.display = 'block';
            logArea.innerHTML = `<div class="log-waiting">‚è≥ ƒêang chu·∫©n b·ªã t·∫£i ${files.length} file...</div>`;

            // Duy·ªát qua t·ª´ng file v√† upload l·∫ßn l∆∞·ª£t (Tu·∫ßn t·ª±)
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t b·∫•m
                btn.innerText = `ƒêang t·∫£i (${i+1}/${files.length})...`;
                
                // In log ƒëang t·∫£i
                logArea.innerHTML += `<div id="log-${i}" class="log-waiting">‚û§ ƒêang t·∫£i: ${file.name}...</div>`;
                scrollToBottom(logArea);

                try {
                    // G·ªçi h√†m upload t·ª´ng file v√† ƒë·ª£i n√≥ xong m·ªõi qua file ti·∫øp theo
                    await uploadSingleFile(file);
                    
                    // Update log th√†nh c√¥ng
                    document.getElementById(`log-${i}`).innerHTML = `‚úÖ ƒê√£ xong: ${file.name}`;
                    document.getElementById(`log-${i}`).className = "log-item log-success";
                } catch (error) {
                    // Update log l·ªói
                    document.getElementById(`log-${i}`).innerHTML = `‚ùå L·ªói: ${file.name} (${error})`;
                    document.getElementById(`log-${i}`).className = "log-item log-error";
                }
            }

            // Ho√†n t·∫•t
            btn.disabled = false;
            btn.innerText = "‚¨ÜÔ∏è T·∫£i T·∫•t C·∫£ L√™n";
            logArea.innerHTML += `<div style="font-weight:bold; margin-top:10px">üéâ Ho√†n t·∫•t qu√° tr√¨nh!</div>`;
            scrollToBottom(logArea);
            
            fileInput.value = ""; // X√≥a file ƒë√£ ch·ªçn
            loadFiles(); // T·∫£i l·∫°i danh s√°ch
        }

        // H√†m con: Upload 1 file duy nh·∫•t (Tr·∫£ v·ªÅ Promise)
        function uploadSingleFile(file) {
            return new Promise((resolve, reject) => {
                if(file.size > 50 * 1024 * 1024) {
                    reject("File qu√° l·ªõn > 50MB");
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function() {
                    const base64 = reader.result.split(',')[1];
                    
                    fetch(SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            base64: base64,
                            mimeType: file.type,
                            filename: file.name
                        })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if(res.status === "success") resolve();
                        else reject(res.message);
                    })
                    .catch(err => reject("L·ªói m·∫°ng"));
                };
                reader.onerror = () => reject("L·ªói ƒë·ªçc file");
            });
        }

        // H√†m t·∫£i danh s√°ch (gi·ªØ nguy√™n)
        function loadFiles() {
            const listDiv = document.getElementById('fileList');
            listDiv.innerHTML = '<div style="text-align:center">‚è≥ ƒêang c·∫≠p nh·∫≠t...</div>';
            
            fetch(SCRIPT_URL + "?action=list")
            .then(r => r.json())
            .then(files => {
                if(!files || files.length === 0) {
                    listDiv.innerHTML = "<div style='text-align:center;color:#888'>Th∆∞ m·ª•c tr·ªëng</div>";
                    return;
                }
                let html = "";
                files.forEach(f => {
                    let date = new Date(f.date).toLocaleDateString('vi-VN');
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name" title="${f.name}">${f.name}</div>
                                <div style="font-size:11px; color:#888">${f.size} ‚Ä¢ ${date}</div>
                            </div>
                            <a href="${f.link}" class="btn-down">‚¨á T·∫£i</a>
                        </div>
                    `;
                });
                listDiv.innerHTML = html;
            })
            .catch(err => listDiv.innerHTML = "L·ªói t·∫£i danh s√°ch.");
        }
        
        function scrollToBottom(el) { el.scrollTop = el.scrollHeight; }

        // T·ª± ch·∫°y khi v√†o
        loadFiles();
    </script>
</body>
</html>
